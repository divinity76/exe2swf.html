<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <!-- phone optimization -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Web EXE to SWF converter</title>
</head>

<body>
    <input type="file" id="fileInput" />
    

    <div style="margin-top: 0.5rem;">
        <textarea id="log" readonly
            style="width: 100%; height: 200px; box-sizing: border-box; font-family: monospace;"></textarea>
    </div>
    <div id="results_div"></div>
    <br/>
    <br/>
    <span>extraction algorithm provided by <a
            href="http://www.nullsecurity.org/article/extracting_swf_from_flash_projector">nullsecurity.org</a></span>
    <script>
        function forceReflow(element) {
            void (element.offsetHeight); // doesn't  seem to actually work..
        }
        function log(message) {
            const logArea = document.getElementById("log");
            if (logArea.value.length > 0) {
                logArea.value += "\n";
            }
            logArea.value += message;
            logArea.scrollTop = logArea.scrollHeight;
            forceReflow(logArea);
        }
        function bin2hex(uint8array) {
            return (Array.from(uint8array).map(b => b.toString(16).padStart(2, '0')).join('')).toUpperCase();
        }
        function bin2Base64(uint8array) {
            const len = uint8array.length;
            const chars = new Array(len);
            for (let i = 0; i < len; i++) {
                chars[i] = String.fromCharCode(uint8array[i]);
            }
            return btoa(chars.join(''));
        }
        function EXE2SWF(filename, uint8array) {
            log(`Loaded file: ${filename} (${uint8array.length} bytes)`);
            const signatureAsHex = bin2hex(uint8array.slice(-8, uint8array.length - 4));
            if (signatureAsHex !== '563412FA') {
                log("Error: Invalid SWF signature: expected '563412FA', found '" + signatureAsHex + "'");
                return;
            } else {
                log("Valid SWF signature found: '" + signatureAsHex + "'");
            }
            const last_4_bytes_as_little_endian_uint32 =
                uint8array[uint8array.length - 4] |
                (uint8array[uint8array.length - 3] << 8) |
                (uint8array[uint8array.length - 2] << 16) |
                (uint8array[uint8array.length - 1] << 24);
            const swf_length = last_4_bytes_as_little_endian_uint32;
            log(`Extracted SWF length: ${swf_length} bytes`);
            if (swf_length > (uint8array.length - 4 - 4)) {
                log("Error: SWF length exceeds available data: " + swf_length + " > " + (uint8array.length - 4 - 4));
                return;
            }
            const swf_data = uint8array.slice(uint8array.length - 4 - 4 - swf_length, uint8array.length - 4 - 4);
            log(`Extracted SWF data: ${swf_data.length} bytes. Creating download link...`);
            const downloadElement = document.createElement('a');
            downloadElement.href = 'data:application/octet-stream;base64,' + bin2Base64(swf_data);
            downloadElement.textContent = downloadElement.download = filename + ".swf";
            downloadElement.textContent = "Click to download: " + downloadElement.textContent;
            document.getElementById("results_div").appendChild(downloadElement);
            log("Download link created.");
            downloadElement.click();
        };

        if (1) {
            const input = document.getElementById("fileInput");
            input.addEventListener("change", (event) => {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    log(`Reading file: ${file.name} (${file.size} bytes)`);
                    const reader = new FileReader();
                    log("FileReader initialized. Setting events.");
                    reader.onload = function (event) {
                        log("File read successfully.");
                        const buffer = event.target.result;
                        const uint8 = new Uint8Array(buffer);
                        EXE2SWF(file.name, uint8);
                    };
                    reader.onerror = function (event) {
                        log("Error reading file.");
                        log(event.target.error.message);
                        log(event.target.error.stack);
                    };
                    log("Starting to read file as ArrayBuffer.");
                    reader.readAsArrayBuffer(file);
                    log("readAsArrayBuffer called. Waiting for onload or onerror, this may take a while...");
                } catch (e) {
                    log("Error reading file.");
                    log(e.message);
                    log(e.stack);
                }
            });
        }
    </script>
</body>

</html>
